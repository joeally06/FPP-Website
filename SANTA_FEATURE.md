# üéÖ Letter to Santa Feature

A magical Christmas experience that allows children to write letters to Santa and receive personalized AI-generated replies via email.

## Features

‚ú® **For Families:**
- Write letters to Santa through a festive modal interface
- Personalized responses generated by local LLM (Ollama)
- Santa's replies delivered via email with beautiful HTML template
- Rate limiting (1 letter per day per IP)
- Only visible during Christmas theme

üéÑ **For Admins:**
- View all letters in dedicated dashboard
- Filter by status (pending, approved, sent, rejected)
- Edit Santa's replies before sending
- Approve/reject letters
- Resend emails if needed
- Add internal admin notes
- Export letters to CSV

## Setup Instructions

### 1. Install Ollama

Download and install Ollama from https://ollama.ai

Pull a language model (recommended: llama3.2):
```bash
ollama pull llama3.2
```

Start Ollama server (if not auto-started):
```bash
ollama serve
```

### 2. Configure Environment Variables

Copy `.env.example` to `.env.local` and configure:

```env
# Ollama Configuration
OLLAMA_URL=http://localhost:11434

# Email Configuration (SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-gmail-app-password
```

### 3. Set Up Gmail SMTP (if using Gmail)

1. Enable 2-Factor Authentication on your Google account
2. Go to https://myaccount.google.com/apppasswords
3. Generate an App Password for "Mail"
4. Use that 16-character password in `SMTP_PASS`

**Alternative SMTP Providers:**
- **SendGrid**: Great for high volume, free tier available
- **Mailgun**: Reliable, developer-friendly
- **Amazon SES**: Cost-effective for AWS users
- **Microsoft 365**: If you have a business account

### 4. Database Setup

The database migration runs automatically on startup. The `santa_letters` table includes:
- Child information (name, age)
- Parent email
- Letter content
- Santa's AI-generated reply
- Status workflow
- IP tracking for rate limiting
- Admin notes

## Usage

### For Users

1. Visit the jukebox page when **Christmas theme is active**
2. Click the **"‚úâÔ∏è Write to Santa!"** button
3. Fill out the form:
   - Child's name (required)
   - Child's age (optional)
   - Parent's email (required)
   - Letter content (required, max 2000 characters)
4. Submit and wait for Santa's magical reply!

The LLM generates a personalized response that:
- Thanks the child by name
- References specific items from their letter
- Mentions elves, reindeer, or Mrs. Claus
- Encourages kindness and good behavior
- Signs as "Santa Claus, North Pole"

### For Admins

1. Navigate to **üéÖ Santa Letters** in admin navigation
2. View statistics dashboard
3. Filter letters by status
4. Click **View** on any letter to:
   - Read the full letter
   - Edit Santa's reply
   - Approve/reject the letter
   - Resend email if needed
   - Add internal notes
5. Export all letters to CSV for record-keeping

## Technical Architecture

### Flow Diagram

```
User submits letter
    ‚Üì
Rate limit check (1/day per IP)
    ‚Üì
Save to database (status: pending)
    ‚Üì
Generate reply via Ollama LLM
    ‚Üì
Update database with reply (status: approved)
    ‚Üì
Send email via Nodemailer
    ‚Üì
Update status to 'sent'
```

### Key Files

**Frontend:**
- `components/LetterToSantaModal.tsx` - User-facing form
- `app/santa-letters/page.tsx` - Admin dashboard

**Backend:**
- `app/api/santa/send-letter/route.ts` - Letter submission
- `app/api/santa/admin-letters/route.ts` - Admin CRUD operations
- `app/api/santa/resend-email/route.ts` - Email resending

**Services:**
- `lib/ollama-client.ts` - LLM integration
- `lib/email-service.ts` - Email delivery
- `lib/database.ts` - Santa letters table schema

### Database Schema

```sql
CREATE TABLE santa_letters (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  child_name TEXT NOT NULL,
  child_age INTEGER,
  parent_email TEXT NOT NULL,
  letter_content TEXT NOT NULL,
  santa_reply TEXT,
  status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'sent', 'rejected')),
  ip_address TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  sent_at DATETIME,
  admin_notes TEXT
);
```

## Customization

### Change LLM Model

Edit `lib/ollama-client.ts`:
```typescript
const request: OllamaRequest = {
  model: 'llama3.2', // Change to: mistral, llama2, etc.
  // ...
};
```

### Customize Santa's Prompt

Edit the `systemPrompt` in `lib/ollama-client.ts` to adjust Santa's personality and response style.

### Adjust Rate Limiting

Edit `app/api/santa/send-letter/route.ts`:
```typescript
const RATE_LIMIT_WINDOW = 24 * 60 * 60 * 1000; // 24 hours
const MAX_LETTERS_PER_DAY = 1; // Change this number
```

### Modify Email Template

Edit `lib/email-service.ts` - the `createSantaEmailHTML` function contains the festive HTML template.

## Security Features

‚úÖ **Rate Limiting:** 1 letter per day per IP address
‚úÖ **Content Moderation:** Basic keyword filtering
‚úÖ **Input Validation:** Email format, length limits
‚úÖ **Admin-Only Routes:** Protected by NextAuth
‚úÖ **IP Tracking:** For abuse prevention
‚úÖ **Status Workflow:** Admin approval optional

## Troubleshooting

### Emails Not Sending

1. Check SMTP credentials in `.env.local`
2. Verify Gmail App Password is correct
3. Check `testEmailConnection()` in email-service.ts
4. Look at server logs for SMTP errors

### Ollama Not Responding

1. Ensure Ollama is running: `ollama list`
2. Check OLLAMA_URL in `.env.local`
3. Test connection: `curl http://localhost:11434/api/tags`
4. Fallback reply will be used if LLM fails

### Letters Not Appearing in Dashboard

1. Check database file exists: `votes.db`
2. Verify `santa_letters` table created
3. Check browser console for API errors
4. Ensure admin authentication is working

## Future Enhancements

- [ ] Multi-language support
- [ ] Image upload for children's drawings
- [ ] Voice message replies
- [ ] Integration with Christmas light sequences
- [ ] Automated approval for certain keywords
- [ ] Parent verification via email confirmation
- [ ] Anonymous letters option
- [ ] Letter categories (nice list, wish list, etc.)

## Credits

Built with:
- **Next.js 16** - React framework
- **Ollama** - Local LLM inference
- **Nodemailer** - Email delivery
- **SQLite** - Database storage
- **NextAuth** - Authentication

---

üéÑ **Merry Christmas!** üéÖ
